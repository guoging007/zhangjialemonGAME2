<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>張家檸檬店</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: '微軟正黑體', sans-serif;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .background {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 0;
      object-fit: cover;
    }

    #score-board {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-weight: bold;
      font-size: 1.4em;
      text-shadow: 2px 2px 0 #000;
      z-index: 10;
    }

    #day-count {
      position: absolute;
      top: 10px;
      right: 10px;
      color: white;
      font-weight: bold;
      font-size: 1.4em;
      text-shadow: 2px 2px 0 #000;
      z-index: 10;
    }

    #lemon-logo {
      position: absolute;
      right: 30px;
      bottom: 30px;
      width: 150px;
      z-index: 12;
    }

    .ingredient {
      position: absolute;
      bottom: 20px;
      width: 90px;
      user-select: none;
      z-index: 15;
    }

    #lemon {
      right: 130px;
    }

    #sugar {
      left: 20px;
    }

    .ingredient-count {
      position: absolute;
      bottom: 10px;
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 0 #000;
      z-index: 16;
    }

    .customer {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      transition: opacity 0.5s;
      z-index: 5;
    }

    .dialogue {
      position: absolute;
      bottom: 20px;
      left: 55%;
      transform: translateX(0%);
      font-size: 18px;
      color: white;
      font-weight: bold;
      padding: 10px 16px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      text-shadow: 2px 2px 0 black;
      z-index: 11;
    }

    #continue-btn {
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform: translate(-50%, 50%);
      background-color: #ffc107;
      padding: 16px 32px;
      font-size: 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px black;
      display: none;
      z-index: 20;
    }

    #ghost-cg {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <img id="bg" class="background" src="背景1.png" alt="背景">
    
    <div id="score-board">剩餘時間：2:00</div>
    <div id="day-count">第 1 天</div>
    
    <img id="lemon" class="ingredient" src="檸檬圖片1.png" alt="檸檬">
    <div class="ingredient-count" style="right: 130px; bottom: 110px;" id="lemon-count">x 0</div>
    
    <img id="sugar" class="ingredient" src="白糖1.png" alt="白糖">
    <div class="ingredient-count" style="left: 20px; bottom: 110px;" id="sugar-count">∞</div>
    
    <img id="buddha" class="ingredient" src="佛書1.png" alt="佛書" style="right: 20px; display: none;">
    
    <img id="customer" class="customer" src="客人1.png" style="display: none;">
    <div id="dialogue" class="dialogue" style="display: none;"></div>
    
    <img id="ghost-cg" src="女鬼CG1.png" alt="女鬼CG">
    
    <button id="continue-btn">繼續遊戲</button>
  </div>

  <script>
    // JavaScript 程式碼將於下一段提供
    let lemonClick = 0;
    let lemonStock = 0;
    let score = 0;
    let day = 1;
    let timer;
    let timeLeft = 120;
    let ghostDays = [3, 7, 10, 15];
    let ghostPassed = new Set();
    let ghostFinalTriggered = false;
    let currentCustomer = null;
    let buddhaShown = false;
    let isGamePaused = false;

    const bg = document.getElementById("bg");
    const lemonCount = document.getElementById("lemon-count");
    const sugarCount = document.getElementById("sugar-count");
    const lemonLogo = document.getElementById("lemon-logo");
    const customerImg = document.getElementById("customer");
    const dialogueBox = document.getElementById("dialogue");
    const ghostCG = document.getElementById("ghost-cg");
    const continueBtn = document.getElementById("continue-btn");
    const scoreBoard = document.getElementById("score-board");
    const dayCount = document.getElementById("day-count");

    function updateCountUI() {
      lemonCount.innerText = `x ${lemonStock}`;
      sugarCount.innerText = `∞`;
    }

    function startGame() {
      timeLeft = 120;
      isGamePaused = false;
      score = 0;
      lemonClick = 0;
      lemonStock = 0;
      updateCountUI();
      updateTimerUI();
      bg.src = "背景1.png";
      lemonLogo.style.right = "30px";
      lemonLogo.style.bottom = "30px";
      ghostCG.style.display = "none";
      continueBtn.style.display = "none";
      dialogueBox.style.display = "none";
      customerImg.style.display = "none";

      timer = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timer);
          onGameEnd();
        } else {
          timeLeft--;
          updateTimerUI();
        }
      }, 1000);
    }

    function updateTimerUI() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      scoreBoard.innerText = `剩餘時間：${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    document.getElementById("lemon").addEventListener("click", () => {
      if (isGamePaused) return;
      lemonClick++;
      const lemon = document.getElementById("lemon");
      lemon.style.transform = "scale(0.9)";
      setTimeout(() => { lemon.style.transform = "scale(1)"; }, 100);
      if (lemonClick >= 10) {
        lemonClick = 0;
        lemonStock++;
        updateCountUI();
      }
    });
    function spawnCustomer(type = "normal") {
      if (isGamePaused) return;
      customerImg.style.display = "block";
      dialogueBox.style.display = "block";

      let needLemon = Math.floor(Math.random() * 5) + 1;
      let needSugar = Math.floor(Math.random() * 4);
      let image = "客人1.png";

      if (type === "ghost") {
        image = "女鬼1.png";
        needSugar = Math.floor(Math.random() * 3);
      }

      if (type === "ghost2") {
        image = "女鬼2.png";
      }

      if (type === "ghostFinal") {
        triggerGhostEnding();
        return;
      }

      if (type === "5") {
        image = "客人5.png";
        needSugar = 0;
      }

      currentCustomer = {
        type,
        lemon: needLemon,
        sugar: needSugar,
        servedLemon: 0,
        servedSugar: 0,
      };

      customerImg.src = image;
      dialogueBox.innerText = `我要 ${needLemon} 杯飲料 ${needSugar > 0 ? "+ " + needSugar + " 糖" : ""}`;

      let waitTime = 15000;
      if (type === "ghost") waitTime = 30000;

      setTimeout(() => {
        if (currentCustomer && !isGamePaused) {
          failCustomer();
        }
      }, waitTime);
    }

    function deliverItem(type) {
      if (!currentCustomer || isGamePaused) return;
      if (type === "lemon" && currentCustomer.servedLemon < currentCustomer.lemon && lemonStock > 0) {
        currentCustomer.servedLemon++;
        lemonStock--;
        updateCountUI();
      }
      if (type === "sugar" && currentCustomer.servedSugar < currentCustomer.sugar) {
        currentCustomer.servedSugar++;
      }
      if (type === "buddha" && currentCustomer.type === "8") {
        currentCustomer.type = "8開心";
        customerImg.src = "客人8開心.png";
        dialogueBox.innerText = "心靈被淨化了……";
        return setTimeout(() => endCustomer(true), 1500);
      }

      if (
        currentCustomer.servedLemon >= currentCustomer.lemon &&
        currentCustomer.servedSugar >= currentCustomer.sugar
      ) {
        if (currentCustomer.type === "5" && (type === "sugar" || type === "buddha")) {
          customerImg.src = "客人5難過.png";
        }
        if (currentCustomer.type === "7") {
          buddhaShown = true;
          document.getElementById("buddha").style.display = "block";
          dialogueBox.innerText = "南無阿彌陀佛～";
        } else if (currentCustomer.type === "6") {
          dialogueBox.innerText = "這店家得了 MVP！";
        } else {
          dialogueBox.innerText = "感謝光臨！";
        }

        if (currentCustomer.type === "ghost") {
          setTimeout(() => {
            customerImg.src = "女鬼2.png";
            setTimeout(() => endCustomer(true), 5000);
          }, 500);
        } else {
          setTimeout(() => endCustomer(true), 1500);
        }
      }
    }
    function failCustomer() {
      if (!currentCustomer) return;
      if (currentCustomer.type === "2") {
        lemonStock = Math.floor(lemonStock * 0.25);
        updateCountUI();
      }
      dialogueBox.innerText = "他生氣走了！";
      setTimeout(() => endCustomer(false), 1500);
    }

    function endCustomer(success) {
      currentCustomer = null;
      customerImg.style.display = "none";
      dialogueBox.style.display = "none";
      if (success) score += 10;
      else score -= 5;
      setTimeout(spawnCustomer, Math.random() * 3000 + 3000);
    }

    function onGameEnd() {
      isGamePaused = true;
      bg.src = "背景晚上1.png";

      // 女鬼特別邏輯
      if (ghostDays.includes(day) && !ghostPassed.has(day)) {
        setTimeout(() => {
          spawnCustomer("ghost");
          ghostPassed.add(day);
        }, 10000);
        return;
      }

      // 最終女鬼劇情
      if (day === 20 && ghostDays.every(d => ghostPassed.has(d)) && !ghostFinalTriggered) {
        ghostFinalTriggered = true;
        setTimeout(() => spawnCustomer("ghostFinal"), 10000);
        return;
      }

      // 普通分數結算
      setTimeout(() => {
        continueBtn.style.display = "block";
      }, 1500);
    }

    function triggerGhostEnding() {
      let step = 0;
      const sequence = [
        () => (dialogueBox.innerText = "（不小心脚滑跌倒）", dialogueBox.style.display = "block"),
        () => (dialogueBox.innerText = "你沒事嗎？"),
        () => (bg.src = "背景1.png"),
        () => (dialogueBox.innerText = "（突然看到一個女生）"),
        () => (ghostCG.style.display = "block"),
        () => (dialogueBox.innerText = "謝謝你，你的檸檬茶很好喝，"),
        () => (dialogueBox.innerText = "但是我有事情，我必須離開這裡了，"),
        () => (dialogueBox.innerText = "下次有機會再見面。"),
        () => {
          ghostCG.style.display = "none";
          bg.src = "背景晚上1.png";
        },
        () => {
          dialogueBox.style.display = "none";
          continueBtn.style.display = "block";
        },
      ];

      function nextStep() {
        if (step < sequence.length) {
          sequence[step++]();
          const delay = step === 1 ? 3000 : step === 3 ? 3000 : step === 8 ? 3000 : 2000;
          setTimeout(nextStep, delay);
        }
      }

      nextStep();
    }

    function setupDrag(id, type) {
      const el = document.getElementById(id);
      el.addEventListener("touchstart", e => {
        const touch = e.touches[0];
        el.dataset.offsetX = touch.clientX - el.offsetLeft;
        el.dataset.offsetY = touch.clientY - el.offsetTop;
      });

      el.addEventListener("touchmove", e => {
        e.preventDefault();
        const touch = e.touches[0];
        el.style.left = `${touch.clientX - el.dataset.offsetX}px`;
        el.style.top = `${touch.clientY - el.dataset.offsetY}px`;
      });

      el.addEventListener("touchend", () => {
        const c = customerImg.getBoundingClientRect();
        const r = el.getBoundingClientRect();
        if (
          r.right > c.left &&
          r.left < c.right &&
          r.bottom > c.top &&
          r.top < c.bottom
        ) {
          deliverItem(type);
        }
        el.style.left = "";
        el.style.top = "";
      });
    }

    setupDrag("lemon", "lemon");
    setupDrag("sugar", "sugar");
    setupDrag("buddha", "buddha");

    continueBtn.addEventListener("click", () => {
      day++;
      dayCount.innerText = `第 ${day} 天`;
      startGame();
    });

    startGame();
  </script>
</body>
</html>
