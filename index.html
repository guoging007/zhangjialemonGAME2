<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>å¼µå®¶æª¸æª¬åº—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-drag: none;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      background-color: black;
      touch-action: manipulation; /* âœ… ç¦æ­¢é›™é»ç¸®æ”¾ */
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    #background {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    #timer, #day {
      position: absolute;
      top: 1vh;
      font-size: 4.2vw;
      font-weight: 900;
      color: white;
      text-shadow: 2px 2px black;
      z-index: 20;
    }
    #timer { left: 2vw; }
    #day { right: 2vw; }
    .item {
      position: absolute;
      width: 16vw;
      cursor: pointer;
      z-index: 10;
    }
    #lemonDrink { top: 40%; right: 8vw; }
    #lemonDrinkCount {
      position: absolute;
      right: 8vw;
      top: 36%;
      font-size: 5vw;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px black;
      z-index: 11;
    }
    #sugar { top: 40%; left: 4vw; }
    #buddhaBook {
      position: absolute;
      right: 2vw;
      bottom: 5vw;
      width: 14vw; /* âœ… æ”¾å¤§ä¸€é» */
      z-index: 100;
    }
    #lemon {
      left: 45vw;
      top: 20%;
      width: 16vw;
      z-index: 10;
    }
    #customer {
      position: absolute;
      left: 4vw;
      bottom: 6vh;
      width: 30vw;
      z-index: 15;
      transform: none;
    }
    #dialogue {
      position: absolute;
      bottom: 17%;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      max-width: 70vw;
      color: white;
      font-size: 3.8vw;
      text-shadow: 2px 2px black;
      z-index: 16;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      padding: 1vw 2vw;
      border-radius: 1vw;
    }
    #scoreBoard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      color: white;
      text-align: center;
      font-size: 2vw;
      display: none;
    }
    #scoreText {
      margin-top: 30vh;
    }
    button {
      margin-top: 2vh;
      padding: 1vh 3vw;
      font-size: 1.5vw;
    }
    .shake {
      animation: shake 0.3s infinite;
    }
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      25% { transform: translate(-1px, -2px) rotate(-1deg); }
      50% { transform: translate(-3px, 0px) rotate(1deg); }
      75% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -1px) rotate(1deg); }
    }

  </style>
</head>
<body>
  <div class="game-container">
    <img id="background" src="èƒŒæ™¯1.png" alt="èƒŒæ™¯" />
    <div id="timer">02:00</div>
    <div id="day">Day 1</div>
    <!-- å®¢äººåœ–ç‰‡ -->
    <img id="customer" src="" />

    <!-- å°è©±æ¡† -->
    <div id="dialogue"></div>

    <!-- æª¸æª¬é£²æ–™åœ–ï¼ˆå³ä¸Šè§’ï¼‰ -->
    <img id="lemonDrink" class="item" src="æª¸æª¬é£²æ–™åœ–ç‰‡1.png" draggable="false" />
    <div id="lemonDrinkCount">0</div>

    <!-- ç™½ç³–åœ–ï¼ˆå·¦ä¸Šè§’ï¼‰ -->
    <img id="sugar" class="item" src="ç™½ç³–1.png" draggable="false" />

    <!-- ä½›æ›¸ï¼ˆä»»å‹™ç²å¾—æ‰æœƒé¡¯ç¤ºï¼‰ -->
    <img id="buddhaBook" class="item" src="ä½›æ›¸1.png" draggable="false" />

    <!-- æª¸æª¬åœ–ï¼ˆä¸­é–“åå·¦ï¼‰ -->
    <img id="lemon" class="item" src="æª¸æª¬åœ–ç‰‡1.png" draggable="false" />

    <!-- åˆ†æ•¸çµç®—ç•«é¢ -->
    <div id="scoreBoard">
      <div id="scoreText">å¾—åˆ†ï¼š0</div>
      <button onclick="nextDay()">ç¹¼çºŒéŠæˆ²</button>
    </div>
  </div>
<script>
let day = 1;
let timeLeft = 120;
let lemonCount = 0;
let lemonClickCount = 0;
let score = 0;
let buddhaShown = false;
let customerActive = false;
let customer8Converted = false;
let gotBuddhaBook = false;
let customerTimer = null;
let ghostDays = [3, 7, 10, 15];
let ghostDone = [false, false, false, false];
let ghostCGTriggered = false;
let customer5Fails = [false, false, false, false];
let customer5StoryDone = false;

const background = document.getElementById("background");
const timer = document.getElementById("timer");
const dayText = document.getElementById("day");
const lemonDrink = document.getElementById("lemonDrink");
const lemonDrinkCount = document.getElementById("lemonDrinkCount");
const sugar = document.getElementById("sugar");
const buddhaBook = document.getElementById("buddhaBook");
const lemon = document.getElementById("lemon");
const customer = document.getElementById("customer");
const dialogue = document.getElementById("dialogue");
const scoreBoard = document.getElementById("scoreBoard");
const scoreText = document.getElementById("scoreText");

function formatTime(t) {
  const m = Math.floor(t / 60).toString().padStart(2, '0');
  const s = (t % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

function updateUI() {
  timer.textContent = formatTime(timeLeft);
  dayText.textContent = `Day ${day}`;
  lemonDrinkCount.textContent = lemonCount;
}

function nextDay() {
  day++;
  startGame();
}

let extraCustomersThisRound = [];

function startGame() {
  timeLeft = 120;
  lemonCount = 0;
  customerActive = false;
  updateUI();
  background.src = "èƒŒæ™¯1.png";
  scoreBoard.style.display = "none";
  buddhaBook.style.display = gotBuddhaBook ? "block" : "none";
  customer.style.display = "none";
  dialogue.style.display = "none";

  // æ¯å ´éŠæˆ²å…ˆæŠ½å‡ºç‰¹æ®Šå®¢äºº
  const candidates = [3, 6, 7, 8];
  extraCustomersThisRound = [];

  const count = randomRange(1, 2);
  while (extraCustomersThisRound.length < count) {
    const pick = candidates[Math.floor(Math.random() * candidates.length)];
    if (!extraCustomersThisRound.includes(pick)) {
      extraCustomersThisRound.push(pick);
    }
  }

  spawnCustomer();

  const timerInterval = setInterval(() => {
  timeLeft--;
  updateUI();
  if (timeLeft <= 0) {
    clearInterval(timerInterval);
    endGame();
  }
}, 1000); // âœ… é€™ä¸€è¡Œæ˜¯çµå°¾ï¼Œä¸èƒ½å°‘ï¼

} // âœ… â†â†â† æœ€çµ‚æ­£ç¢ºé—œé–‰æ•´å€‹ startGame() å‡½å¼


lemon.addEventListener("click", () => {
  lemonClickCount++;
  lemon.style.transform = "scale(1.2)";
  setTimeout(() => lemon.style.transform = "scale(1)", 100);
  if (navigator.vibrate) navigator.vibrate(50);

  if (lemonClickCount >= 10) {
    lemonClickCount = 0;
    lemonCount++;
    lemonDrinkCount.textContent = lemonCount;
    lemonDrink.style.transform = "scale(1.3)";
    setTimeout(() => lemonDrink.style.transform = "scale(1)", 100);
  }
}); // âœ… åŠ ä¸Šé€™ä¸€è¡Œé—œé–‰ click functionï¼
function enableDraggable(imgElement, type) {
  imgElement.addEventListener("pointerdown", (e) => {
    const clone = imgElement.cloneNode(true);
    clone.style.position = "absolute";
    clone.style.left = e.clientX + "px";
    clone.style.top = e.clientY + "px";
    clone.style.opacity = "0.9";
    clone.style.pointerEvents = "none";
    clone.style.touchAction = "none"; // âœ… æ–°å¢ï¼šæ‰‹æ©Ÿæ‹–æ›³æ»‘é †
    clone.style.transform = "translate(-50%, -50%)"; // âœ… æ–°å¢ï¼šè®“æ‰‹æŒ‡ä¸­å¿ƒå°é½Š clone ä¸­å¿ƒ
    clone.style.width = "14vw";
    clone.id = "dragClone";
    document.body.appendChild(clone);

    const move = (e) => {
      clone.style.left = e.clientX + "px";
      clone.style.top = e.clientY + "px";
    };

 const up = (e) => {
  document.removeEventListener("pointermove", move);
  document.removeEventListener("pointerup", up);

  const customerRect = customer.getBoundingClientRect();
  const cloneRect = clone.getBoundingClientRect();

  const cloneCenterX = cloneRect.left + cloneRect.width / 2;
  const cloneCenterY = cloneRect.top + cloneRect.height / 2;
  const customerCenterX = customerRect.left + customerRect.width / 2;
  const customerCenterY = customerRect.top + customerRect.height / 2;

  const distance = Math.sqrt(
    Math.pow(cloneCenterX - customerCenterX, 2) +
    Math.pow(cloneCenterY - customerCenterY, 2)
  );

  const hit = distance < 100;

  if (hit) {
    handleDrop();
  }

  if (clone && clone.parentNode) 
    clone.remove();
}
  setTimeout(() => {
  const leftovers = document.getElementById("dragClone");
  if (leftovers) document.body.removeChild(leftovers);
 }, 5000);

    document.addEventListener("pointermove", move);
    document.addEventListener("pointerup", up);
  }); // âœ… <<<<<< æ­£ç¢ºè£œä¸Šçš„é—œé–‰å¤§æ‹¬è™Ÿ
}
function spawnCustomer() {
  if (customerActive) return;

  customerActive = true;

  // å®¢äººé¡å‹
  let customerType = randomCustomerType();
  customer.dataset.type = customerType;

  // åœ–ç‰‡è¨­å®š
  if (customerType === 8 && customer8Converted) {
    customer.src = "å®¢äºº8é–‹å¿ƒ.png";
  } else {
    customer.src = `å®¢äºº${customerType}.png`;
  }

  customer.style.display = "block";

  // ä»»å‹™éœ€æ±‚
  let lemonNeed = generateLemonNeed(customerType);
  let sugarNeed = generateSugarNeed(customerType);
  customer.dataset.lemon = lemonNeed;
  customer.dataset.sugar = sugarNeed;

  // é¡¯ç¤ºå°è©±
  dialogue.textContent = getCustomerDialogue(customerType, lemonNeed, sugarNeed);
  dialogue.style.display = "block";

  // è¨­å®šç­‰å¾…æ™‚é–“
  let waitTime = getCustomerWaitTime(customerType);
  customer.dataset.wait = waitTime;

  customerTimer = setTimeout(() => {
    if (customerActive) handleFail(customerType);
  }, waitTime * 1000);
}

function generateLemonNeed(type) {
  if (type === 3) return randomRange(1, 2);
  if (type === 5) return 1;
  if (type === 8 && !customer8Converted) return 0;
  return randomRange(1, 5);
}

function generateSugarNeed(type) {
  if (type === 3) return 30;
  if (type === 5 || (type === 8 && !customer8Converted)) return 0;
  return randomRange(0, 3);
}

function getCustomerDialogue(type, lemon, sugar) {
  if (type === 8 && !customer8Converted) return "é€™ä»€éº¼ç ´åº—å•Šï¼Œæ°£æ­»æˆ‘äº†ï¼";
  if (type === 5 && lemon > 0) return `æˆ‘è¦ ${lemon} æ¯æª¸æª¬èŒ¶`;

  let text = "æˆ‘è¦ ";
  if (sugar > 0) text += `${sugar} ä»½ç™½ç³– `;
  if (lemon > 0) text += `${lemon} æ¯æª¸æª¬èŒ¶`;
  return text.trim();
}

function getCustomerWaitTime(type) {
  if (day === 1) return 30;
  if (type === 2) return randomRange(12, 17);
  if (type === 3) return 30; // âœ… å®¢äºº3å›ºå®šç­‰å¾…30ç§’
  if (type === 8) return 15;
  if (type >= 4 && type <= 8) return randomRange(10, 15);
  return randomRange(12, 17); // å®¢äºº1èˆ‡é è¨­é‚è¼¯
}


function randomRange(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function randomCustomerType() {
  if (day < 2) return 1;

  // ä¿è­‰æ¯å›åˆæœ€å¤šåªå‡ºç¾ 1ï½2 ä½ç‰¹æ®Šå®¢äººï¼ˆ3/6/7/8ï¼‰
  let baseTypes = [1, 2];

  // åŠ å…¥é€™å›åˆå…è¨±å‡ºç¾çš„é¡å¤–å®¢äºº
  baseTypes = baseTypes.concat(extraCustomersThisRound);

  return baseTypes[Math.floor(Math.random() * baseTypes.length)];
}
// æ‹–æ›³æ©Ÿåˆ¶
let draggedItem = null;

[lemonDrink, sugar, buddhaBook].forEach(item => {
  item.addEventListener("touchstart", e => {
    draggedItem = item;
  });
  item.addEventListener("mousedown", e => {
    draggedItem = item;
  });
});

customer.addEventListener("touchend", handleDrop);
customer.addEventListener("mouseup", handleDrop);

function handleDrop() {
  if (!draggedItem || !customerActive) return;

  const type = customer.dataset.type;
  let lemonNeed = parseInt(customer.dataset.lemon || 0);
  let sugarNeed = parseInt(customer.dataset.sugar || 0);

  const itemId = draggedItem.id;

  if (itemId === "lemonDrink" && lemonCount > 0 && lemonNeed > 0) {
    lemonCount--;
    lemonNeed--;
    customer.dataset.lemon = lemonNeed;
  }
  else if (itemId === "sugar" && sugarNeed > 0) {
    sugarNeed--;
    customer.dataset.sugar = sugarNeed;
  }
  else if (itemId === "buddhaBook" && type === "8" && !customer8Converted) {
    customer.src = "å®¢äºº8é–‹å¿ƒ.png";
    customer8Converted = true;
    dialogue.textContent = "è¬è¬ä½ â€¦ï¼ˆä¸ç½µäº†ï¼‰";
    return;
  }
  else {
    // ä»»å‹™éŒ¯èª¤è™•ç†ï¼ˆå®¢äºº5 æˆ– å…¶ä»–éŒ¯èª¤çµ¦é“å…·ï¼‰
    if (type === "5") {
      customer.src = "å®¢äºº5é›£é.png";
      customer.dataset.fail = "true";
    }
    return;
  }

  updateUI();
  checkTaskComplete();
}

function checkTaskComplete() {
  const lemonLeft = parseInt(customer.dataset.lemon || 0);
  const sugarLeft = parseInt(customer.dataset.sugar || 0);
  if (lemonLeft <= 0 && sugarLeft <= 0) {
    completeTask();
  }
}

function completeTask() {
  clearTimeout(customerTimer);
  customerActive = false;

  const type = parseInt(customer.dataset.type);
  dialogue.textContent = "è¬è¬ï¼";

  if (type === 6) {
    dialogue.textContent = "é€™åº—å®¶å¾—äº† MVPï¼";
  }
 if (type === 7) {
  dialogue.textContent = "å—ç„¡é˜¿å½Œé™€ä½›~";
  buddhaBook.style.display = "block";
  enableDraggable(buddhaBook, "buddha");
  gotBuddhaBook = true;
}

  if (type === 5 && customer.dataset.fail === "true") {
    score -= 5;
  } else {
    score += (type >= 5 && type <= 8) ? 20 : 10;
  }

  customer.style.transform = "translateX(100vw)";
  setTimeout(() => {
    customer.style.display = "none";
    dialogue.style.display = "none";
    customer.style.transform = "translateX(0)";
    spawnNextCustomer();
  }, 1000);
}

function handleFail(type) {
  customerActive = false;

  if (type == 2) {
    lemonCount = Math.floor(lemonCount * 0.25);
  }

  if (type == 5 && day <= 15) {
    const failIndex = [5,8,12,15].indexOf(day);
    if (failIndex !== -1) customer5Fails[failIndex] = true;
  }

  score -= 5;

  dialogue.textContent = "ï¼ˆå®¢äººç”Ÿæ°£é›¢é–‹ï¼‰";
  customer.style.transform = "translateX(100vw)";
  setTimeout(() => {
    customer.style.display = "none";
    dialogue.style.display = "none";
    customer.style.transform = "translateX(0)";
    spawnNextCustomer();
  }, 1000);
}
function spawnNextCustomer() {
  setTimeout(() => {
    if (day === 20 && !ghostCGTriggered) {
      triggerGhostCG();
    } else if (day === 17 && !customer5StoryDone && customer5Fails.every(v => v)) {
      triggerCustomer5CG();
    } else {
      spawnCustomer();
    }
  }, randomRange(3000, 7000));
}

// ğŸ‘» å¥³é¬¼åŠ‡æƒ…è§¸ç™¼é»ï¼ˆç¬¬ 3, 7, 10, 15 å¤©ï¼‰
function checkGhostDay() {
  const ghostIndex = ghostDays.indexOf(day);
  if (ghostIndex === -1 || ghostDone[ghostIndex]) return false;

  setTimeout(() => {
    spawnGhost(ghostIndex);
  }, 10000);

  return true;
}

function spawnGhost(index) {
  customer.dataset.type = 'ghost';
  customer.src = "å¥³é¬¼1.png";
  customer.style.display = "block";
  const lemonNeed = randomRange(1, 3);
  const sugarNeed = randomRange(0, 2);
  customer.dataset.lemon = lemonNeed;
  customer.dataset.sugar = sugarNeed;
  dialogue.textContent = getCustomerDialogue(1, lemonNeed, sugarNeed);
  dialogue.style.display = "block";

  customerTimer = setTimeout(() => {
    handleFail('ghost');
  }, randomRange(12, 17) * 1000);
}

function completeGhost(index) {
  customer.src = "å¥³é¬¼2.png";
  ghostDone[index] = true;
  setTimeout(() => {
    endGame();
  }, 5000);
}

// ğŸŒ• å¥³é¬¼CG ç¬¬ 20 å¤©äº‹ä»¶
function triggerGhostCG() {
  ghostCGTriggered = true;
  let steps = [
    "ï¼ˆä¸å°å¿ƒè„šæ»‘è·Œå€’ï¼‰",
    "ä½ æ²’äº‹å—",
    "ï¼ˆçªç„¶çœ‹åˆ°ä¸€å€‹å¥³ç”Ÿï¼‰",
    "CG",  // CGè½‰æ›
    "è¬è¬ä½ ï¼Œä½ çš„æª¸æª¬èŒ¶å¾ˆå¥½å–ï¼Œ",
    "ä½†æ˜¯æˆ‘æœ‰äº‹æƒ…ï¼Œæˆ‘å¿…é ˆé›¢é–‹é€™è£¡äº†ï¼Œ",
    "ä¸‹æ¬¡æœ‰æ©Ÿæœƒå†è¦‹é¢ã€‚"
  ];
  let i = 0;

  function next() {
    if (i === 3) {
      background.src = "å¥³é¬¼CG1.png";
    } else if (i < steps.length) {
      dialogue.textContent = steps[i];
      dialogue.style.display = "block";
    }

    i++;
    if (i < steps.length) {
      setTimeout(next, i === 3 ? 3000 : 2000);
    } else {
      dialogue.style.display = "none";
      background.src = "èƒŒæ™¯æ™šä¸Š1.png";
      setTimeout(() => endGame(), 3000);
    }
  }

  background.src = "èƒŒæ™¯æ™šä¸Š1.png";
  setTimeout(next, 1000);
}

// ğŸ§ƒ å®¢äºº5 CG å°è©±è§¸ç™¼ï¼ˆç¬¬ 17 å¤©ï¼‰
function triggerCustomer5CG() {
  customer.style.display = "none";
  dialogue.style.display = "none";
  background.src = "å®¢äºº5CG1.png";

  let msgs = [
    ". . . . . .",
    "é‚£å€‹æˆ‘èªªä¸åŠ ç³–...",
    "ä½ é‚„åŠ ç³–çµ¦æˆ‘...",
    "CG",
    "ä¸‹æ¬¡å¯ä»¥...",
    "éº»ç…©ä¸è¦å†åŠ ç³–çµ¦æˆ‘...",
    "...."
  ];
  let idx = 0;

  function next() {
    if (msgs[idx] === "CG") {
      background.src = "å®¢äºº5CG2.png";
      idx++;
      setTimeout(next, 3000);
    } else {
      dialogue.textContent = msgs[idx];
      dialogue.style.display = "block";
      idx++;
      if (idx < msgs.length) {
        setTimeout(next, 2000);
      } else {
        dialogue.style.display = "none";
        background.src = "èƒŒæ™¯1.png";
        customer5StoryDone = true;
        score += 20;
        spawnCustomer();
      }
    }
  }

  setTimeout(next, 1000);
}
function endGame() {
  customer.style.display = "none";
  dialogue.style.display = "none";
  background.src = "èƒŒæ™¯æ™šä¸Š1.png";

  setTimeout(() => {
    scoreBoard.style.display = "block";
    scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
  }, 1000);
}

// å•Ÿå‹•æµç¨‹
document.addEventListener("DOMContentLoaded", () => {
  updateUI();
  startGame();
  enableDraggable(lemonDrink, "lemon");
  enableDraggable(sugar, "sugar");
  enableDraggable(buddhaBook, "buddha");
});
</script>
</body>
</html>

