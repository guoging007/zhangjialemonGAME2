<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>張家檸檬店</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-drag: none;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "微軟正黑體", sans-serif;
      background-color: black;
      touch-action: manipulation; /* ✅ 禁止雙點縮放 */
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    #background {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    #timer, #day {
      position: absolute;
      top: 1vh;
      font-size: 4.2vw;
      font-weight: 900;
      color: white;
      text-shadow: 2px 2px black;
      z-index: 20;
    }
    #timer { left: 2vw; }
    #day { right: 2vw; }
    .item {
      position: absolute;
      width: 16vw;
      cursor: pointer;
      z-index: 10;
    }
    #lemonDrink { top: 40%; right: 8vw; }
    #lemonDrinkCount {
      position: absolute;
      right: 8vw;
      top: 36%;
      font-size: 5vw;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px black;
      z-index: 11;
    }
    #sugar { top: 40%; left: 4vw; }
    #buddhaBook {
      position: absolute;
      right: 2vw;
      bottom: 5vw;
      width: 14vw; /* ✅ 放大一點 */
      z-index: 100;
    }
    #lemon {
      left: 45vw;
      top: 20%;
      width: 16vw;
      z-index: 10;
    }
    #customer {
      position: absolute;
      left: 4vw;
      bottom: 6vh;
      width: 30vw;
      z-index: 15;
      transform: none;
    }
    #dialogue {
      position: absolute;
      bottom: 17%;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      max-width: 70vw;
      color: white;
      font-size: 3.8vw;
      text-shadow: 2px 2px black;
      z-index: 16;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      padding: 1vw 2vw;
      border-radius: 1vw;
    }
    #scoreBoard {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      color: white;
      text-align: center;
      font-size: 2vw;
      display: none;
    }
    #scoreText {
      margin-top: 30vh;
    }
    button {
      margin-top: 2vh;
      padding: 1vh 3vw;
      font-size: 1.5vw;
    }
    .shake {
      animation: shake 0.3s infinite;
    }
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      25% { transform: translate(-1px, -2px) rotate(-1deg); }
      50% { transform: translate(-3px, 0px) rotate(1deg); }
      75% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -1px) rotate(1deg); }
    }

  </style>
</head>
<body>
  <div class="game-container">
    <img id="background" src="背景1.png" alt="背景" />
    <div id="timer">02:00</div>
    <div id="day">Day 1</div>
    <!-- 客人圖片 -->
    <img id="customer" src="" />

    <!-- 對話框 -->
    <div id="dialogue"></div>

    <!-- 檸檬飲料圖（右上角） -->
    <img id="lemonDrink" class="item" src="檸檬飲料圖片1.png" draggable="false" />
    <div id="lemonDrinkCount">0</div>

    <!-- 白糖圖（左上角） -->
    <img id="sugar" class="item" src="白糖1.png" draggable="false" />

    <!-- 佛書（任務獲得才會顯示） -->
    <img id="buddhaBook" class="item" src="佛書1.png" draggable="false" />

    <!-- 檸檬圖（中間偏左） -->
    <img id="lemon" class="item" src="檸檬圖片1.png" draggable="false" />

    <!-- 分數結算畫面 -->
    <div id="scoreBoard">
      <div id="scoreText">得分：0</div>
      <button onclick="nextDay()">繼續遊戲</button>
    </div>
  </div>
<script>
let day = 1;
let timeLeft = 120;
let lemonCount = 0;
let lemonClickCount = 0;
let score = 0;
let buddhaShown = false;
let customerActive = false;
let customer8Converted = false;
let gotBuddhaBook = false;
let customerTimer = null;
let ghostDays = [3, 7, 10, 15];
let ghostDone = [false, false, false, false];
let ghostCGTriggered = false;
let customer5Fails = [false, false, false, false];
let customer5StoryDone = false;

const background = document.getElementById("background");
const timer = document.getElementById("timer");
const dayText = document.getElementById("day");
const lemonDrink = document.getElementById("lemonDrink");
const lemonDrinkCount = document.getElementById("lemonDrinkCount");
const sugar = document.getElementById("sugar");
const buddhaBook = document.getElementById("buddhaBook");
const lemon = document.getElementById("lemon");
const customer = document.getElementById("customer");
const dialogue = document.getElementById("dialogue");
const scoreBoard = document.getElementById("scoreBoard");
const scoreText = document.getElementById("scoreText");

function formatTime(t) {
  const m = Math.floor(t / 60).toString().padStart(2, '0');
  const s = (t % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

function updateUI() {
  timer.textContent = formatTime(timeLeft);
  dayText.textContent = `Day ${day}`;
  lemonDrinkCount.textContent = lemonCount;
}

function nextDay() {
  day++;
  startGame();
}

let extraCustomersThisRound = [];

function startGame() {
  timeLeft = 120;
  lemonCount = 0;
  customerActive = false;
  updateUI();
  background.src = "背景1.png";
  scoreBoard.style.display = "none";
  buddhaBook.style.display = gotBuddhaBook ? "block" : "none";
  customer.style.display = "none";
  dialogue.style.display = "none";

  // 每場遊戲先抽出特殊客人
  const candidates = [3, 6, 7, 8];
  extraCustomersThisRound = [];

  const count = randomRange(1, 2);
  while (extraCustomersThisRound.length < count) {
    const pick = candidates[Math.floor(Math.random() * candidates.length)];
    if (!extraCustomersThisRound.includes(pick)) {
      extraCustomersThisRound.push(pick);
    }
  }

  spawnCustomer();

  const timerInterval = setInterval(() => {
  timeLeft--;
  updateUI();
  if (timeLeft <= 0) {
    clearInterval(timerInterval);
    endGame();
  }
}, 1000); // ✅ 這一行是結尾，不能少！

} // ✅ ←←← 最終正確關閉整個 startGame() 函式


lemon.addEventListener("click", () => {
  lemonClickCount++;
  lemon.style.transform = "scale(1.2)";
  setTimeout(() => lemon.style.transform = "scale(1)", 100);
  if (navigator.vibrate) navigator.vibrate(50);

  if (lemonClickCount >= 10) {
    lemonClickCount = 0;
    lemonCount++;
    lemonDrinkCount.textContent = lemonCount;
    lemonDrink.style.transform = "scale(1.3)";
    setTimeout(() => lemonDrink.style.transform = "scale(1)", 100);
  }
}); // ✅ 加上這一行關閉 click function！
function enableDraggable(imgElement, type) {
  imgElement.addEventListener("pointerdown", (e) => {
    const clone = imgElement.cloneNode(true);
    clone.style.position = "absolute";
    clone.style.left = e.clientX + "px";
    clone.style.top = e.clientY + "px";
    clone.style.opacity = "0.9";
    clone.style.pointerEvents = "none";
    clone.style.touchAction = "none"; // ✅ 新增：手機拖曳滑順
    clone.style.transform = "translate(-50%, -50%)"; // ✅ 新增：讓手指中心對齊 clone 中心
    clone.style.width = "14vw";
    clone.id = "dragClone";
    document.body.appendChild(clone);

    const move = (e) => {
      clone.style.left = e.clientX + "px";
      clone.style.top = e.clientY + "px";
    };

 const up = (e) => {
  document.removeEventListener("pointermove", move);
  document.removeEventListener("pointerup", up);

  const customerRect = customer.getBoundingClientRect();
  const cloneRect = clone.getBoundingClientRect();

  const cloneCenterX = cloneRect.left + cloneRect.width / 2;
  const cloneCenterY = cloneRect.top + cloneRect.height / 2;
  const customerCenterX = customerRect.left + customerRect.width / 2;
  const customerCenterY = customerRect.top + customerRect.height / 2;

  const distance = Math.sqrt(
    Math.pow(cloneCenterX - customerCenterX, 2) +
    Math.pow(cloneCenterY - customerCenterY, 2)
  );

  const hit = distance < 100;

  if (hit) {
    handleDrop();
  }

  if (clone && clone.parentNode) 
    clone.remove();
}
  setTimeout(() => {
  const leftovers = document.getElementById("dragClone");
  if (leftovers) document.body.removeChild(leftovers);
 }, 5000);

    document.addEventListener("pointermove", move);
    document.addEventListener("pointerup", up);
  }); // ✅ <<<<<< 正確補上的關閉大括號
}
function spawnCustomer() {
  if (customerActive) return;

  customerActive = true;

  // 客人類型
  let customerType = randomCustomerType();
  customer.dataset.type = customerType;

  // 圖片設定
  if (customerType === 8 && customer8Converted) {
    customer.src = "客人8開心.png";
  } else {
    customer.src = `客人${customerType}.png`;
  }

  customer.style.display = "block";

  // 任務需求
  let lemonNeed = generateLemonNeed(customerType);
  let sugarNeed = generateSugarNeed(customerType);
  customer.dataset.lemon = lemonNeed;
  customer.dataset.sugar = sugarNeed;

  // 顯示對話
  dialogue.textContent = getCustomerDialogue(customerType, lemonNeed, sugarNeed);
  dialogue.style.display = "block";

  // 設定等待時間
  let waitTime = getCustomerWaitTime(customerType);
  customer.dataset.wait = waitTime;

  customerTimer = setTimeout(() => {
    if (customerActive) handleFail(customerType);
  }, waitTime * 1000);
}

function generateLemonNeed(type) {
  if (type === 3) return randomRange(1, 2);
  if (type === 5) return 1;
  if (type === 8 && !customer8Converted) return 0;
  return randomRange(1, 5);
}

function generateSugarNeed(type) {
  if (type === 3) return 30;
  if (type === 5 || (type === 8 && !customer8Converted)) return 0;
  return randomRange(0, 3);
}

function getCustomerDialogue(type, lemon, sugar) {
  if (type === 8 && !customer8Converted) return "這什麼破店啊，氣死我了！";
  if (type === 5 && lemon > 0) return `我要 ${lemon} 杯檸檬茶`;

  let text = "我要 ";
  if (sugar > 0) text += `${sugar} 份白糖 `;
  if (lemon > 0) text += `${lemon} 杯檸檬茶`;
  return text.trim();
}

function getCustomerWaitTime(type) {
  if (day === 1) return 30;
  if (type === 2) return randomRange(12, 17);
  if (type === 3) return 30; // ✅ 客人3固定等待30秒
  if (type === 8) return 15;
  if (type >= 4 && type <= 8) return randomRange(10, 15);
  return randomRange(12, 17); // 客人1與預設邏輯
}


function randomRange(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function randomCustomerType() {
  if (day < 2) return 1;

  // 保證每回合最多只出現 1～2 位特殊客人（3/6/7/8）
  let baseTypes = [1, 2];

  // 加入這回合允許出現的額外客人
  baseTypes = baseTypes.concat(extraCustomersThisRound);

  return baseTypes[Math.floor(Math.random() * baseTypes.length)];
}
// 拖曳機制
let draggedItem = null;

[lemonDrink, sugar, buddhaBook].forEach(item => {
  item.addEventListener("touchstart", e => {
    draggedItem = item;
  });
  item.addEventListener("mousedown", e => {
    draggedItem = item;
  });
});

customer.addEventListener("touchend", handleDrop);
customer.addEventListener("mouseup", handleDrop);

function handleDrop() {
  if (!draggedItem || !customerActive) return;

  const type = customer.dataset.type;
  let lemonNeed = parseInt(customer.dataset.lemon || 0);
  let sugarNeed = parseInt(customer.dataset.sugar || 0);

  const itemId = draggedItem.id;

  if (itemId === "lemonDrink" && lemonCount > 0 && lemonNeed > 0) {
    lemonCount--;
    lemonNeed--;
    customer.dataset.lemon = lemonNeed;
  }
  else if (itemId === "sugar" && sugarNeed > 0) {
    sugarNeed--;
    customer.dataset.sugar = sugarNeed;
  }
  else if (itemId === "buddhaBook" && type === "8" && !customer8Converted) {
    customer.src = "客人8開心.png";
    customer8Converted = true;
    dialogue.textContent = "謝謝你…（不罵了）";
    return;
  }
  else {
    // 任務錯誤處理（客人5 或 其他錯誤給道具）
    if (type === "5") {
      customer.src = "客人5難過.png";
      customer.dataset.fail = "true";
    }
    return;
  }

  updateUI();
  checkTaskComplete();
}

function checkTaskComplete() {
  const lemonLeft = parseInt(customer.dataset.lemon || 0);
  const sugarLeft = parseInt(customer.dataset.sugar || 0);
  if (lemonLeft <= 0 && sugarLeft <= 0) {
    completeTask();
  }
}

function completeTask() {
  clearTimeout(customerTimer);
  customerActive = false;

  const type = parseInt(customer.dataset.type);
  dialogue.textContent = "謝謝！";

  if (type === 6) {
    dialogue.textContent = "這店家得了 MVP！";
  }
 if (type === 7) {
  dialogue.textContent = "南無阿彌陀佛~";
  buddhaBook.style.display = "block";
  enableDraggable(buddhaBook, "buddha");
  gotBuddhaBook = true;
}

  if (type === 5 && customer.dataset.fail === "true") {
    score -= 5;
  } else {
    score += (type >= 5 && type <= 8) ? 20 : 10;
  }

  customer.style.transform = "translateX(100vw)";
  setTimeout(() => {
    customer.style.display = "none";
    dialogue.style.display = "none";
    customer.style.transform = "translateX(0)";
    spawnNextCustomer();
  }, 1000);
}

function handleFail(type) {
  customerActive = false;

  if (type == 2) {
    lemonCount = Math.floor(lemonCount * 0.25);
  }

  if (type == 5 && day <= 15) {
    const failIndex = [5,8,12,15].indexOf(day);
    if (failIndex !== -1) customer5Fails[failIndex] = true;
  }

  score -= 5;

  dialogue.textContent = "（客人生氣離開）";
  customer.style.transform = "translateX(100vw)";
  setTimeout(() => {
    customer.style.display = "none";
    dialogue.style.display = "none";
    customer.style.transform = "translateX(0)";
    spawnNextCustomer();
  }, 1000);
}
function spawnNextCustomer() {
  setTimeout(() => {
    if (day === 20 && !ghostCGTriggered) {
      triggerGhostCG();
    } else if (day === 17 && !customer5StoryDone && customer5Fails.every(v => v)) {
      triggerCustomer5CG();
    } else {
      spawnCustomer();
    }
  }, randomRange(3000, 7000));
}

// 👻 女鬼劇情觸發點（第 3, 7, 10, 15 天）
function checkGhostDay() {
  const ghostIndex = ghostDays.indexOf(day);
  if (ghostIndex === -1 || ghostDone[ghostIndex]) return false;

  setTimeout(() => {
    spawnGhost(ghostIndex);
  }, 10000);

  return true;
}

function spawnGhost(index) {
  customer.dataset.type = 'ghost';
  customer.src = "女鬼1.png";
  customer.style.display = "block";
  const lemonNeed = randomRange(1, 3);
  const sugarNeed = randomRange(0, 2);
  customer.dataset.lemon = lemonNeed;
  customer.dataset.sugar = sugarNeed;
  dialogue.textContent = getCustomerDialogue(1, lemonNeed, sugarNeed);
  dialogue.style.display = "block";

  customerTimer = setTimeout(() => {
    handleFail('ghost');
  }, randomRange(12, 17) * 1000);
}

function completeGhost(index) {
  customer.src = "女鬼2.png";
  ghostDone[index] = true;
  setTimeout(() => {
    endGame();
  }, 5000);
}

// 🌕 女鬼CG 第 20 天事件
function triggerGhostCG() {
  ghostCGTriggered = true;
  let steps = [
    "（不小心脚滑跌倒）",
    "你沒事嗎",
    "（突然看到一個女生）",
    "CG",  // CG轉換
    "謝謝你，你的檸檬茶很好喝，",
    "但是我有事情，我必須離開這裡了，",
    "下次有機會再見面。"
  ];
  let i = 0;

  function next() {
    if (i === 3) {
      background.src = "女鬼CG1.png";
    } else if (i < steps.length) {
      dialogue.textContent = steps[i];
      dialogue.style.display = "block";
    }

    i++;
    if (i < steps.length) {
      setTimeout(next, i === 3 ? 3000 : 2000);
    } else {
      dialogue.style.display = "none";
      background.src = "背景晚上1.png";
      setTimeout(() => endGame(), 3000);
    }
  }

  background.src = "背景晚上1.png";
  setTimeout(next, 1000);
}

// 🧃 客人5 CG 對話觸發（第 17 天）
function triggerCustomer5CG() {
  customer.style.display = "none";
  dialogue.style.display = "none";
  background.src = "客人5CG1.png";

  let msgs = [
    ". . . . . .",
    "那個我說不加糖...",
    "你還加糖給我...",
    "CG",
    "下次可以...",
    "麻煩不要再加糖給我...",
    "...."
  ];
  let idx = 0;

  function next() {
    if (msgs[idx] === "CG") {
      background.src = "客人5CG2.png";
      idx++;
      setTimeout(next, 3000);
    } else {
      dialogue.textContent = msgs[idx];
      dialogue.style.display = "block";
      idx++;
      if (idx < msgs.length) {
        setTimeout(next, 2000);
      } else {
        dialogue.style.display = "none";
        background.src = "背景1.png";
        customer5StoryDone = true;
        score += 20;
        spawnCustomer();
      }
    }
  }

  setTimeout(next, 1000);
}
function endGame() {
  customer.style.display = "none";
  dialogue.style.display = "none";
  background.src = "背景晚上1.png";

  setTimeout(() => {
    scoreBoard.style.display = "block";
    scoreText.textContent = `得分：${score}`;
  }, 1000);
}

// 啟動流程
document.addEventListener("DOMContentLoaded", () => {
  updateUI();
  startGame();
  enableDraggable(lemonDrink, "lemon");
  enableDraggable(sugar, "sugar");
  enableDraggable(buddhaBook, "buddha");
});
</script>
</body>
</html>

